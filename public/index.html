<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>

  <style>
    body > img {
      width: 100px;
      height: 100px;
      position: absolute;
    }

    html, body {
      overflow: hidden;
      margin: 0;
      height: 100%;
      background-size: 100px;
      background-image: url("img/grass.jpg");
    }

    .player {
      z-index: 1;
      background-position-y: -15px;
      width: 200px;
      height: 230px;
      background-image: url("img/sprite2.png");
      background-size: 700px;
      position: absolute;
    }

    .player:after {
      content: attr(id);
      color: yellow;
      font-family: monospace;
      left: 50%;
      position: absolute;
      transform: translateX(-50%);
      font-size: 25px;
      margin-top: -35px;
      background-color: rgba(0,0,0,0.4);
      padding: 7px;
    }

    #character {
      background-image: url("img/sprite.png");
      z-index: 2;
    }

    #character:after {
      color: #4ba3e6;
      content: attr(data-name);
    }

    #blockBar {
      z-index: 3;
      position: fixed;
      width: auto;
      bottom: 10px;
      height: 65px;
      background-color: gray;
      left: 50%;
      transform: translateX(-50%);
      padding: 5px;
      border-radius: 5px;
      box-shadow: 4px 4px 20px -5px black;
    }

    #blockBar img {
      height: 100%;
      border: 5px solid grey;
      box-sizing: border-box;
    }

    #blockBar img.active {
      border-color: red;
    }

  </style>
</head>
<body id="page">

<div class="player" data-mooving="false" id="character"></div>
<div id="blockBar">
  <img src="img/cobble.png" alt="">
  <img src="img/cobble.png" alt="">
  <img src="img/cobble.png" alt="">
  <img src="img/cobble.png" alt="">
  <img src="img/cobble.png" alt="">
</div>

<script src="http://localhost:8001/socket.io/socket.io.js"></script>

<script>
  var socket = io.connect('http://localhost:8001')

  body = document.getElementById('page')
  isleft = false
  isright = false
  isup = false
  isdown = false
  posX = 0
  posY = 0
  body.addEventListener('keydown', move)
  body.addEventListener('keyup', unmove)
  spritestate = 0
  var pseudo

  function unmove (e) {
    if (e.key === 'd') {
      isright = false
    }
    if (e.key === 'q') {
      isleft = false
    }
    if (e.key === 'z') {
      isup = false
    }
    if (e.key === 's') {
      isdown = false
    }
    if (!isright && !isleft && !isup && !isdown) {
      document.getElementById('character').setAttribute('data-mooving', false)
    }
  }

  function move (e) {
    var player = document.getElementById('character')
    if (e.key === 'd') {
      document.getElementById('character').setAttribute('data-mooving', true)
      isright = true
    }
    if (e.key === 'q') {
      document.getElementById('character').setAttribute('data-mooving', true)
      isleft = true
    }
    if (e.key === 'z') {
      document.getElementById('character').setAttribute('data-mooving', true)
      isup = true
    }
    if (e.key === 's') {
      document.getElementById('character').setAttribute('data-mooving', true)
      mooving = 1
      isdown = true
    }
  }

  function setsprite () {
    spritestate++
    if (spritestate >= 4) {
      spritestate = 0
    }
    var characters = document.getElementsByClassName('player')
    for (let i = 0; i < characters.length; i++) {
      if (spritestate === 0 || spritestate === 2 || characters[i].getAttribute('data-mooving') === 'false') {
        characters[i].style.height = '230px'
        characters[i].style.backgroundPositionY = '-15px'
      }
      if (spritestate === 1 && characters[i].getAttribute('data-mooving') === 'true') {
        characters[i].style.height = '230px'
        characters[i].style.backgroundPositionY = '250px'
      }
      if (spritestate === 3 && characters[i].getAttribute('data-mooving') === 'true') {
        characters[i].style.backgroundPositionY = '445px'
        characters[i].style.height = '210px'
      }
    }
  }

  function domove () {
    var character = document.getElementById('character')
    if (isright) {
      character.style.backgroundPositionX = '365px'
      posX += 10
      character.style.left = posX + 'px'
    }
    if (isleft) {
      character.style.backgroundPositionX = '0px'
      posX -= 10
      character.style.left = posX + 'px'
    }
    if (isup) {
      character.style.backgroundPositionX = '200px'
      posY -= 10
      character.style.top = posY + 'px'
    }
    if (isdown) {
      character.style.backgroundPositionX = '530px'
      posY += 10
      character.style.top = posY + 'px'
    }
    if (pseudo)
      socket.emit('update_pos', {
        pseudo: pseudo,
        mooving: character.getAttribute('data-mooving'),
        posX: posX,
        posY: posY,
        isright: isright,
        isleft: isleft,
        isup: isup,
        isdown: isdown,
      })
  }

  setInterval(setsprite, 300)
  setInterval(domove, 50)

  //TODO

  /* TODO permettre au cousin de Steve de poser des blocs de cobblestone (balises img) sous ses pieds
   ----------------------------
   Résoudre l'exercice en utilisant JavaScript et en ajoutant du code dans cette balise <script> uniquement.
   En appuyant sur la barre espace : créer une nouvelle balise HTML à l'aide de la methode .createElement et positionner
   ce nouvel élement sous le personnage (div ayant l'id character) :

   Cours:
   https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement
   https://www.w3schools.com/jsref/met_document_createelement.asp
   https://openclassrooms.com/fr/courses/1916641-dynamisez-vos-sites-web-avec-javascript/1918600-manipuler-le-code-html-partie-2-2#/id/r-1924593
    */
  function createBlock (x, y, id) {
    var perso = document.getElementById('character')
    var block = document.createElement('img')
    block.src = 'img/' + blocks[id]
    block.style.left = x * 100 + 'px'
    block.style.top = y * 100 + 'px'
    var body = document.getElementById('page')
    body.appendChild(block)
  }

  document.getElementById('page').addEventListener('keydown',
    function (event) {
      if (event.keyCode === 32) {
        var x = Math.floor((posX + 100) / 100)
        var y = Math.floor((posY + 200) / 100)
        var id = blockId
        if (pseudo)
          socket.emit('create_block', { x: x, y: y, id: id })
        createBlock(x, y, id)
      }
    })
  socket.on('created_block', function (message) {
    createBlock(message.x, message.y, message.id)
  })
  socket.on('connect_message', function (message) {
    pseudo = null;
    while (!pseudo)
      pseudo = prompt(message)
    document.getElementById('character').setAttribute('data-name', pseudo)
    if (pseudo)
      socket.emit('login', pseudo)
  })
  socket.on('user_quit', function (message) {
    document.getElementById(message).remove()
  })

  function create_user (pseudo, x, y) {
    var player = document.getElementById(pseudo)
    if (!player) {
      var perso = document.createElement('div')
      perso.classList.add('player')
      perso.id = pseudo
      perso.style.left = x
      perso.style.top = y
      perso.setAttribute('data-mooving', false)
      var body = document.getElementById('page')
      body.appendChild(perso)
    }
  }

  socket.on('new_user', function (message) {
    create_user(message, 0, 0)
  })
  socket.on('user_moove', function (message) {
    userMoove(message.pseudo, message.posX, message.posY, message.mooving, message.isleft, message.isright, message.isup, message.isdown)
  })

  function userMoove (id, posX, posY, mooving, isLeft, isRight, isUp, isDown) {

    var player = document.getElementById(id)
    if (player) {
      if (isRight)
        player.style.backgroundPositionX = '365px'
      if (isLeft)
        player.style.backgroundPositionX = '0px'
      if (isUp)
        player.style.backgroundPositionX = '200px'
      if (isDown)
        player.style.backgroundPositionX = '530px'
      player.setAttribute('data-mooving', mooving)
      player.style.top = posY + 'px'
      player.style.left = posX + 'px'
    } else {
      create_user(id, posX, posY)
    }
  }

  document.getElementById('page').addEventListener('wheel',
    function (event) {
      if (event.deltaY < 0) {
        selectBlock(blockId + 1)
      } else {
        selectBlock(blockId + 1)
      }
    })
  var blockBar = document.getElementById('blockBar')
  var blocks = [
    'cobble.png',
    'sand.jpg',
    'stone.png',
    'water.jpg',
    'grass.jpg'
  ]
  var blockId = 0

  function selectBlock (id) {
    blockId = id
    if (blockId >= blocks.length) {
      blockId = 0
    }
    while (blockBar.firstChild) {
      blockBar.removeChild(blockBar.firstChild)
    }
    for (let i = 0; i < blocks.length; i++) {
      var img = document.createElement('img')
      img.src = 'img/' + blocks[i]
      img.addEventListener('click', function () {
        selectBlock(i)
      })
      if (blockId === i) {
        img.classList.add('active')
      }
      blockBar.appendChild(img)
    }
  }

  selectBlock(0)

</script>

</body>
</html>
